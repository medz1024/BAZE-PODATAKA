CREATE DATABASE IB140108
USE IB140108

CREATE TABLE ZAPOSLENICI (
ZAPOSLENIKID INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
IME NVARCHAR(30) NOT NULL,
PREZIME NVARCHAR(30) NOT NULL,
SPOL NVARCHAR(10) NOT NULL,
JMBG NVARCHAR(13) NOT NULL,
DATUMRODJENJA DATETIME NOT NULL DEFAULT GETDATE(),
ADRESA NVARCHAR(100) NOT NULL,
EMAIL NVARCHAR(100) NOT NULL UNIQUE,
KORISNICKOIME NVARCHAR(60) NOT NULL,
LOZINKA NVARCHAR(30) NOT NULL
)

CREATE TABLE ARTIKLI(
ARTIKALID INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
NAZIV NVARCHAR(50) NOT NULL,
CIJENA DECIMAL(18,2) NOT NULL,
STANJENASKLADISTU INT NOT NULL,


)

CREATE TABLE PRODAJA(

DATUM DATETIME NOT NULL DEFAULT GETDATE(),
KOLICINA DECIMAL(18,2) NOT NULL,
ZAPOSLENIKID INT FOREIGN KEY(ZAPOSLENIKID) REFERENCES ZAPOSLENICI(ZAPOSLENIKID),
ARTIKALID INT FOREIGN KEY(ARTIKALID) REFERENCES ARTIKLI(ARTIKALID),
PRIMARY KEY(DATUM,ZAPOSLENIKID,ARTIKALID)

)


INSERT INTO ZAPOSLENICI(IME,PREZIME,SPOL,JMBG,DATUMRODJENJA,ADRESA,EMAIL,KORISNICKOIME,LOZINKA)
SELECT E.FirstName AS IME,
	   E.LastName AS PREZIME,
	   REPLACE(REPLACE(REPLACE(REPLACE(E.TitleOfCourtesy,'Mr.','M'),'Ms.','Z'),'Dr.','M'),'Mrs.','Z')  AS SPOL,
	   CONVERT(NVARCHAR,DATEPART(dd,E.BirthDate)) + CONVERT(NVARCHAR,DATEPART(mm,E.BirthDate))+CONVERT(NVARCHAR,DATEPART(yyyy,E.BirthDate)) AS JMBG,
	   E.BirthDate AS DATUMRODJENJA,
	   E.Country +','+ E.City + ',' + E.Address  AS ADRESA,
	   E.FirstName+'['+RIGHT(YEAR(E.BirthDate),2)+']@poslovna.ba' AS EMAIL,
	   UPPER(E.FirstName+'.'+E.LastName) AS 'KORISNICKO IME',
	   REVERSE(REPLACE(SUBSTRING(E.Notes,15,6)+SUBSTRING(E.Extension,0,2)+' ' + CONVERT(NVARCHAR,DATEDIFF("d",E.BirthDate,E.HireDate)),' ','#')) AS LOZINKA
FROM Northwind.dbo.Employees AS E
c 




INSERT INTO ARTIKLI(NAZIV,CIJENA,STANJENASKLADISTU)
SELECT  DISTINCT P.ProductName AS Naziv,
	   P.UnitPrice AS Cijena,
	   P.UnitsInStock AS StanjeNaSkladistu
FROM Northwind.dbo.Products AS P INNER JOIN Northwind.[dbo].[Order Details] AS OD
	 ON P.ProductID=OD.ProductID INNER JOIN Northwind.dbo.Orders AS O
	 ON OD.OrderID=O.OrderID
	 WHERE (YEAR(O.OrderDate)=1997 AND MONTH(O.OrderDate)=8) OR  (MONTH(O.OrderDate)=9 AND YEAR(O.OrderDate)=1997)
Order by Naziv ASC


INSERT INTO PRODAJA(DATUM,KOLICINA,ZAPOSLENIKID,ARTIKALID)
SELECT O.OrderDate AS DATUM,
	   OD.Quantity AS KOLICINA,
	   (SELECT ZAPOSLENIKID FROM ZAPOSLENICI
		WHERE IME=E.FirstName) AS ZAPOSLENIKID,
	   (SELECT ARTIKALID FROM ARTIKLI
		WHERE NAZIV=P.ProductName) AS ARTIKALID
FROM Northwind.dbo.[Order Details] AS  OD INNER JOIN Northwind.dbo.Orders AS O
	 ON OD.OrderID=O.OrderID INNER JOIN Northwind.dbo.Employees AS E
	 ON O.EmployeeID=E.EmployeeID INNER JOIN Northwind.dbo.Products AS P
	 ON OD.ProductID=P.ProductID
WHERE ((YEAR(O.OrderDate)=1997 AND MONTH(O.OrderDate)=8) OR  (MONTH(O.OrderDate)=9 AND YEAR(O.OrderDate)=1997))AND DATEDIFF(YYYY,E.BirthDate,GETDATE()) >60


ALTER TABLE ZAPOSLENICI
ALTER COLUMN ADRESA NVARCHAR(100) NULL

ALTER TABLE ARTIKLI
ADD KATEGORIJA NVARCHAR(50)

UPDATE ARTIKLI
SET KATEGORIJA='HRANA'
WHERE ARTIKALID%3=0


UPDATE ZAPOSLENICI
SET DATUMRODJENJA=DATUMRODJENJA+730
WHERE SPOL LIKE 'Z'

UPDATE ZAPOSLENICI
SET KORISNICKOIME=IME + '_'+SUBSTRING(CAST(YEAR(DATUMRODJENJA) AS NVARCHAR),2,2)+'_'+PREZIME

SELECT P.ProductName AS 'NAZIV PROIZVODA',
	   P.UnitsInStock AS 'STANJE NA ZALIHAMA',
	   P.UnitsOnOrder AS 'BROJ NARUCENIH',
	   P.UnitsOnOrder-P.UnitsInStock AS 'POTREBNO NARUCITI'
FROM Northwind.dbo.Products AS P 
WHERE P.UnitsOnOrder>P.UnitsInStock

SELECT	Z.IME + ' ' + Z.PREZIME AS 'IME I PREZIME',
		A.NAZIV AS NAZIV,
		ISNULL(A.KATEGORIJA,'N/A') AS KATEGORIJA,
		CONVERT(NVARCHAR,ROUND(SUM(P.KOLICINA),2)) + ' kom' AS 'UKUPNA KOLICINA',
		convert(nvarchar,ROUND(SUM(P.KOLICINA*A.CIJENA),2)) + ' KM' AS 'UKUPNA ZARADA'
FROM ZAPOSLENICI AS Z INNER JOIN PRODAJA AS P
	 ON Z.ZAPOSLENIKID=P.ZAPOSLENIKID INNER JOIN ARTIKLI AS A
	 ON P.ARTIKALID=A.ARTIKALID
WHERE Z.ADRESA LIKE '%USA%'
	GROUP BY IME,PREZIME,A.NAZIV,A.KATEGORIJA


SELECT	Z.IME + ' ' + Z.PREZIME AS 'IME I PREZIME',
		A.NAZIV AS NAZIV,
		ISNULL(A.KATEGORIJA,'N/A') AS KATEGORIJA,
		CONVERT(NVARCHAR,ROUND(SUM(P.KOLICINA),2)) + ' kom' AS 'UKUPNA KOLICINA',
		CONVERT(nvarchar,ROUND(SUM(P.KOLICINA*A.CIJENA),2)) + ' KM' AS 'UKUPNA ZARADA',
		P.DATUM AS 'DATUM PRODAJE'
FROM ZAPOSLENICI AS Z INNER JOIN PRODAJA AS P
	 ON Z.ZAPOSLENIKID=P.ZAPOSLENIKID INNER JOIN ARTIKLI AS A
	 ON P.ARTIKALID=A.ARTIKALID
WHERE SPOL LIKE 'Z' AND A.NAZIV LIKE '[CG]%'  AND KATEGORIJA IS NULL AND ((YEAR(P.DATUM)=1997 AND MONTH(P.DATUM)=8 AND DAY(P.DATUM)=22) OR (YEAR(P.DATUM)=1997 AND MONTH(P.DATUM)=9 AND DAY(P.DATUM)=22))
	GROUP BY IME,PREZIME,A.NAZIV,A.KATEGORIJA,P.DATUM


SELECT IME,
	   PREZIME,
	   CONVERT(NVARCHAR,DAY(DATUMRODJENJA))+ '.' +CONVERT(NVARCHAR,MONTH(DATUMRODJENJA))+'.'+CONVERT(NVARCHAR,YEAR(DATUMRODJENJA)),
	   SPOL,
	   COUNT(P.ARTIKALID)AS 'BROJ PRODAJA'
FROM ZAPOSLENICI AS Z INNER JOIN PRODAJA AS P
     ON Z.ZAPOSLENIKID=P.ZAPOSLENIKID
WHERE MONTH(P.DATUM)=8 AND YEAR(P.DATUM)=1997
GROUP BY IME,PREZIME,DATUMRODJENJA,SPOL
ORDER BY [BROJ PRODAJA] DESC

DELETE FROM ZAPOSLENICI
WHERE ADRESA LIKE '%London%'